
&НаКлиенте
Процедура СформироватьОтчет(Команда)
	ФормированиеОтчета();
	
	ЗначениеФункции = ФормированиеОтчета();
	ЗначениеФункции.Показать();
КонецПроцедуры

Функция ФормированиеОтчета() Экспорт
	
	Перем СуммаНаличных;
	Перем СуммаБезналичных;
	Перем Выборка;
	Перем ИтогоНаличных;
	Перем ИтогоБезнала;
	Перем ОбщийИтог;
	
	ИтогоНаличных = 0;
	ИтогоБезнала = 0;
	ОбщийТог = 0;
	
	Макет = ПолучитьМакетНаСервере();
	ТабличныйДокумент = Новый ТабличныйДокумент;
	Запрос = Новый Запрос;
	ПостроительОтчета = Новый ПостроительОтчета;
	
	//Разметка областей из макета
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка");
	ОбластьСтрока = Макет.ПолучитьОбласть("Строка");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	ОбластьПодподвалье = Макет.ПолучитьОбласть ("Подподвалье");	
	
	//Значения даты из формы 	
	ЗначениеПоляВвода = НачалоПериода;
	
	ЗначениеПоляВводаНачалаПериода = НачалоДня(НачалоПериода);
	ЗначениеПоляВводаКонцаПериода = КонецДня(НачалоПериода);
	
	
	Запрос.Текст =   "ВЫБРАТЬ
	                 |	ЧекККМОплата.Ссылка.Дата КАК Дата,
	                 |	ЧекККМОплата.Ссылка.Номер КАК Номер,
	                 |	ЧекККМОплата.Ссылка.ВидОперации КАК ВидОперации,
	                 |	ЧекККМОплата.ВидОплаты КАК ВидОплаты,
	                 |	ЧекККМОплата.Сумма КАК Сумма,
	                 |	ЧекККМОплата.Сумма КАК Наличные,
	                 |	ЧекККМОплата.Сумма КАК Безналичные,
	                 |	ЧекККМОплата.Ссылка.СуммаДокумента КАК СуммаДокумента,
	                 |	ЧекККМОплата.Ссылка.Проведен КАК Проведен
	                 |ИЗ
	                 |	Документ.ЧекККМ.Оплата КАК ЧекККМОплата
	                 |ГДЕ
	                 |	ЧекККМОплата.Ссылка.Дата >= &ДатаНачалаПериода
	                 |	И ЧекККМОплата.Ссылка.Дата <= &ДатаКонцапериода";
	Запрос.УстановитьПараметр("ДатаНачалаПериода", ЗначениеПоляВводаНачалаПериода);
	Запрос.УстановитьПараметр("ДатаКонцаПериода", ЗначениеПоляВводаКонцаПериода);	
	РезультатЗапроса = Запрос.Выполнить();
			
	ПостроительОтчета.ИсточникДанных  = Новый ОписаниеИсточникаДанных(РезультатЗапроса);
	
	Выборка = РезультатЗапроса.Выбрать();
	
	ОбластьЗаголовок.Параметры.ДатаВЗаголовке = Формат(ЗначениеПоляВводаНачалаПериода,"ДФ=dd.MM.yyyy");
	ТабличныйДокумент.Вывести(ОбластьЗаголовок);
	ТабличныйДокумент.Вывести(ОбластьШапка);
	
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Проведен = Ложь Тогда
			Продолжить;
		КонецЕсли;
		
		ОбластьСтрока.Параметры.Дата = Выборка.Дата;
		ОбластьСтрока.Параметры.Номер = Выборка.Номер;			
				
		ОбластьСтрока.Параметры.ВидОперации = Выборка.ВидОперации;
		ОбластьСтрока.Параметры.ВидОплаты = Выборка.ВидОплаты;
		
		Если Выборка.ВидОплаты = Справочники.ВидыОплатЧекаККМ.Наличные Тогда		 
			СуммаНаличных = Выборка.СуммаДокумента;
			Если Выборка.ВидОперации = Перечисления.ВидыОперацийЧекККМ.Возврат Тогда
				 СуммаНаличных = СуммаНаличных * (-1);
			КонецЕсли;
			ОбластьСтрока.Параметры.СуммаНаличных = СуммаНаличных;
			ОбластьСтрока.Параметры.СуммаБезналичных = "-";
			ИтогоНаличных = ИтогоНаличных + СуммаНаличных;
		Иначе 
			СуммаБезналичных = Выборка.Сумма;
			Если Выборка.ВидОперации = Перечисления.ВидыОперацийЧекККМ.Возврат Тогда
				 СуммаБезналичных = СуммаБезналичных * (-1);
			КонецЕсли;
			ОбластьСтрока.Параметры.СуммаБезналичных = СуммаБезналичных;
			ОбластьСтрока.Параметры.СуммаНаличных = "-";
			ИтогоБезнала = ИтогоБезнала + СуммаБезналичных;
		КонецЕсли;
						
		ТабличныйДокумент.Вывести(ОбластьСтрока);
		
		//Условие на возврат
		Если Выборка.ВидОперации = Перечисления.ВидыОперацийЧекККМ.Возврат Тогда
			//Окрашивание текста ячейки в красный
			ОбластьСтрока.Параметры.ВидОперации = Выборка.ВидОперации;
			ТабличныйДокумент.Области.Строка.ЦветТекста = WebЦвета.Красный;
		КонецЕсли;

	КонецЦикла;
	
	ОбщийИтог = ИтогоНаличных + ИтогоБезнала;
	
	ОбластьПодвал.Параметры.ИтогоНаличных = ИтогоНаличных;
	ОбластьПодвал.Параметры.ИтогоБезнала = ИтогоБезнала;
	
	ОбластьПодподвалье.Параметры.ОбщийИтог = ОбщийИтог;
	
	ТабличныйДокумент.Вывести(ОбластьПодвал);
	ТабличныйДокумент.Вывести(ОбластьПодподвалье);
	
	Возврат ТабличныйДокумент
	
КонецФункции

&НаСервере
Функция ПолучитьМакетНаСервере()
	ОтчетОбъект = РеквизитФормыВЗначение("Объект");
	Макет = ОтчетОбъект.ПолучитьМакет("Макет");
	Возврат Макет;
КонецФункции


